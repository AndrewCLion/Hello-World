SET NOCOUNT ON

DECLARE @dbName sysname, @rc int, @login_sid   varbinary(85), @login_name  varchar(85)
DECLARE @SQL nvarchar(4000)

DECLARE @CWIDs TABLE(
        owner_sid VARBINARY(85),
        owner_name VARCHAR(85),
        owner_ssid VARCHAR(85)
)

INSERT INTO @CWIDS (owner_sid, owner_name, owner_ssid)
VALUES --(
	(0x010500000000000515000000D5CB5C589331DA1C828BA6280CD90200,'ad-bayer-cnb\EMFIU (Siegfried Hutscha (2.CWID))','S-1-5-21-1482476501-484061587-682003330-186636'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA6281F650000,'ad-bayer-cnb\IMXRD (Ruediger Kresse (2.CWID))','S-1-5-21-1482476501-484061587-682003330-25887'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA6283E670000,'ad-bayer-cnb\EOTDQ (Armin Steinkaemper (2.CWID))','S-1-5-21-1482476501-484061587-682003330-26430'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA628DB670000,'ad-bayer-cnb\EOLFC (Oliver Hahn (2.CWID))','S-1-5-21-1482476501-484061587-682003330-26587'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62802680000,'ad-bayer-cnb\GBBHG (Roderich Christ (2.CWID))','S-1-5-21-1482476501-484061587-682003330-26626'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA6283F140400,'ad-bayer-cnb\EMHOO (HG Selent-Knips (3. CWID))','S-1-5-21-1482476501-484061587-682003330-267327'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62802560400,'ad-bayer-cnb\EMJSS (HW Greven (1. CWID))','S-1-5-21-1482476501-484061587-682003330-284162'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62805560400,'ad-bayer-cnb\EMJSU (Wilfried Greven (2.CWID))','S-1-5-21-1482476501-484061587-682003330-284165'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62834570400,'ad-bayer-cnb\EMJUS (HW Greven (2. CWID))','S-1-5-21-1482476501-484061587-682003330-284468'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA6281A740000,'ad-bayer-cnb\EOSOX (Christian Polzin (1.CWID))','S-1-5-21-1482476501-484061587-682003330-29722'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA6288DD40400,'ad-bayer-cnb\EMODW (Kevin Filz (2.CWID))','S-1-5-21-1482476501-484061587-682003330-316557'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62892D40400,'ad-bayer-cnb\EMODV (Raphael Niskowski (2.CWID))','S-1-5-21-1482476501-484061587-682003330-316562'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA628D27F0000,'ad-bayer-cnb\IMYFK (Frank Kubina (2.CWID))','S-1-5-21-1482476501-484061587-682003330-32722'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62856990000,'ad-bayer-cnb\EVBOT (Erik Seel (2.CWID))','S-1-5-21-1482476501-484061587-682003330-39254'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62892B20000,'ad-bayer-cnb\ENOYI (Stephan Martin (2.CWID))','S-1-5-21-1482476501-484061587-682003330-45714'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62875BB0000,'ad-bayer-cnb\ENUAG (Michael Conrad (2.CWID))','S-1-5-21-1482476501-484061587-682003330-47989'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA628D9B20000,'ad-bayer-cnb\EOTNM (Christian Polzin (2.CWID))','S-1-5-21-1482476501-484061587-682003330-45785'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62830B10800,'ad-bayer-cnb\ETLBB (Heinrich Jakobi (1.CWID))','S-1-5-21-1482476501-484061587-682003330-569648'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA6289BC20800,'ad-bayer-cnb\ETLIF (Stefan Juergens (2.CWID))','S-1-5-21-1482476501-484061587-682003330-574107'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA628E4C30800,'ad-bayer-cnb\ETLND (Heinrich Jakobi (2.CWID))','S-1-5-21-1482476501-484061587-682003330-574436'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA62837B30900,'ad-bayer-cnb\ETQDY (Frank Laender (2.CWID))','S-1-5-21-1482476501-484061587-682003330-635703'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA6282CA60000,'ad-bayer-cnb\EOAMF (Andrew Craven (1.CWID))','S-1-5-21-1482476501-484061587-682003330-42540'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA628ABE00900,'ad-bayer-cnb\EQZWL (Andrew Craven (2.CWID))','S-1-5-21-1482476501-484061587-682003330-647339'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA628D71C0F00,'AD-BAYER-CNB\EUAYG (John-Christian vom Feld 1.CWID)', 'S-1-5-21-1482476501-484061587-682003330-990423'),
	(0x010500000000000515000000D5CB5C589331DA1C828BA628C0310F00,'AD-BAYER-CNB\EUBNY (John-Christian vom Feld 2.CWID)', 'S-1-5-21-1482476501-484061587-682003330-995776'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BCAAA0F00,'BYACCOUNT\EVBOT (Erik Seel (2.CWID))','S-1-5-21-2050033333-681274564-2079600828-1026762'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B6E3D1000,'BYACCOUNT\EVEGP Ricci (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1064302'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B174A1000,'BYACCOUNT\EVEJQ Ricci (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1067543'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BD8551000,'BYACCOUNT\GBEJW Christian Billig (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1070552'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B5C5E1200,'BYACCOUNT\IMYMR M. Brosda (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1203804'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B5B941300,'BYACCOUNT\EQZWL Andrew Craven (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1283163'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B3FDF1300,'BYACCOUNT\EOAMF Andrew Craven (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1302335'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BA9EF1300,'BYACCOUNT\EOIGW Jost Buchelt (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1306537'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B49FE1300,'BYACCOUNT\EOGMV Martin Volkmann (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1310281'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BE3251400,'BYACCOUNT\EOFVB Martin Volkmann (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1320419'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BB33A1400,'BYACCOUNT\EOICD Jost Buchelt (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1325747'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B2E661400,'BYACCOUNT\EOLFC Oliver Hahn (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1336878'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B936D1400,'BYACCOUNT\EOKOU Oliver Hahn (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1338771'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BC3B81400,'BYACCOUNT\EOSOX Christian Polzin (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1358019'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B5FB91400,'BYACCOUNT\EOSTJ Thomas Seifert (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1358175'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B1ABF1400,'BYACCOUNT\EOTDQ (Armin Steinkämper (2.CWID))','S-1-5-21-2050033333-681274564-2079600828-1359642'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B7FBF1400,'BYACCOUNT\????? Jost Buchelt (3. CWID)','S-1-5-21-2050033333-681274564-2079600828-1359743'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BC1C01400,'BYACCOUNT\EOTNM Christian Polzin (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1360065'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B01C91400,'BYACCOUNT\EOUOI Thomas Seifert (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1362177'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B95101500,'BYACCOUNT\ENDUO Marko Benke (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1380501'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BC8101500,'BYACCOUNT\ENDVA Marko Benke (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1380552'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B54671500,'BYACCOUNT\ENNHY Ian Browning (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1402708'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BD0671500,'BYACCOUNT\ENNIJ Stephan Hafner (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1402832'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BDE691500,'BYACCOUNT\ENNIY Ian Browning (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1403358'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BD8731500,'BYACCOUNT\ENOCA Stephan Hafner (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1405912'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BD27B1500,'BYACCOUNT\ENOQJ Markus Piekarsky (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1407954'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B747C1500,'BYACCOUNT\ENOUB Markus Piekarsky (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1408116'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B857C1500,'BYACCOUNT\ENOVJ Olena Genosko Prokopenko (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1408133'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B867C1500,'BYACCOUNT\ENOVK Stephan Martin (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1408134'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B887C1500,'BYACCOUNT\ENOVM Markus Blohm (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1408136'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BC07C1500,'BYACCOUNT\ENOYI Stephan Martin (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1408192'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BC17C1500,'BYACCOUNT\ENOYJ Markus Blohm (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1408193'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B2B7D1500,'BYACCOUNT\ENPBT Olena Genosko Prokopenko (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1408299'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BEE941500,'BYACCOUNT\ENQXL Frank Mohr (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1414382'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BAB951500,'BYACCOUNT\ENQZI Frank Mohr (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1414571'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BB1AD1500,'BYACCOUNT\ENTBC Reiner Grosser (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1420721'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B7BB11500,'BYACCOUNT\ENTLW Michael Conrad (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1421691'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BD6B11500,'BYACCOUNT\ENTOF Michael Opitz (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1421782'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B1DB61500,'BYACCOUNT\ENUAG Michael Conrad (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1422877'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B43B61500,'BYACCOUNT\ENUBA Reiner Grosser (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1422915'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BB4B81500,'BYACCOUNT\ENUNZ Michael Opitz (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1423540'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B2CFE1500,'BYACCOUNT\EMEUB Hans-Georg Selent-Knips (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1441324'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B58021600,'BYACCOUNT\EMFEW Siegfried Huntscha (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-1442392'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BCC031600,'BYACCOUNT\EMFIU Siegfried Huntscha (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1442764'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BCC0B1600,'BYACCOUNT\EMGJZ Hans-Georg Selent-Knips (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-1444812'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B6B141600,'BYACCOUNT\GHESI (M Brosda (3. CWID))','S-1-5-21-2050033333-681274564-2079600828-1447019'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BB4B20200,'BYACCOUNT\INYBV Oliver Behrs (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-176820'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B29790300,'BYACCOUNT\Server-GDC.DB-Server Server-GDC.DB-Server','S-1-5-21-2050033333-681274564-2079600828-227625'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B16BF0300,'BYACCOUNT\IMXME (Marco Esser (2.CWID))','S-1-5-21-2050033333-681274564-2079600828-245526'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B406C0000,'BYACCOUNT\IMMBR Marcus Brosda (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-27712'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B35910000,'BYACCOUNT\IMVEM Markus Veit (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-37173'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B92B60000,'BYACCOUNT\IMKUF Frank Kubina (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-46738'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BBB7A0700,'BYACCOUNT\GBDZP Christian Billig (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-490171'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B43190000,'BYACCOUNT\INBV  Oliver Behrs (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-6467'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B33170100,'BYACCOUNT\IMYMV Markus Veit (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-71475'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B4E1D0100,'BYACCOUNT\IMYFK Frank Kubina (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-73038'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47BCFB50E00,'BYACCOUNT\SGNTU Rüdiger Kresse (1. CWID)','S-1-5-21-2050033333-681274564-2079600828-964047'),
	(0x010500000000000515000000B506317AC46C9B28BC30F47B59F00E00,'BYACCOUNT\IMXRD Rüdiger Kresse (2. CWID)','S-1-5-21-2050033333-681274564-2079600828-979033')
	--)

--SELECT *, RIGHT(owner_ssid,LEN(owner_ssid) - CHARINDEX('-',owner_ssid,36)) AS ier FROM @CWIDS ORDER BY LEFT(owner_ssid,19), CONVERT(INT,RIGHT(owner_ssid,LEN(owner_ssid) - CHARINDEX('-',owner_ssid,36)))

/*
DECLARE @CWID NVARCHAR(6) = 'EQZWL'
SELECT SUSER_SID('AD-BAYER-CNB\'+@CWID) AS [sid], dbo.fn_SIDToString(SUSER_SID('AD-BAYER-CNB\'+@CWID)) as ssid
*/
--INSERT INTO [TSQL_Crawler_P].[sConfig].[KnownSIDs] ([SID], [Name])
--SELECT owner_sid, owner_name FROM @CWIDS
--WHERE NOT EXISTS (SELECT 1 FROM [TSQL_Crawler_P].[sConfig].[KnownSIDs] WHERE [SID] = owner_sid)
--UPDATE k
--SET k.Name = c.owner_name
----SELECT k.Name,c.owner_name 
--FROM [TSQL_Crawler_P].[sConfig].[KnownSIDs] k INNER JOIN @CWIDS c ON k.SID = c.owner_sid
--WHERE k.Name<>c.owner_name 

SELECT [Instance]
      ,[date]
      ,[DBname]
      ,[DBownerSID]
      ,[DBowner]
	  ,c.owner_name 
      ,[state]
      ,[state_desc]
      ,[is_in_standby]
      ,[compatibility_level]
      ,[user_access_desc]
      ,[is_encrypted]
  FROM [TSQL_Crawler_P].[sCurr].[Current_DBs] d INNER JOIN @CWIDS c ON d.[DBownerSID] = c.owner_sid
  WHERE state=0

SELECT        d.name, d.owner_sid, c.owner_name
INTO #db
FROM            sys.databases d INNER JOIN @CWIDS c ON d.owner_sid = c.owner_sid

SELECT * FROM #db

SELECT @rc = 1, @dbName = MIN(name)
FROM #db

WHILE @rc <> 0
BEGIN
    
	SELECT @login_sid = owner_sid FROM #db WHERE [name] = @dbName
	SET @login_name = SUSER_SNAME(@login_sid)
	SET @SQL = N'USE [' + @dbName + N']
	EXEC sp_changedbowner ''sa'' ; -- from: ' + @login_name

	print @SQL
	--EXEC sp_executesql @SQL

    SELECT TOP 1 @dbName = name
    FROM #db
    WHERE name > @dbName
    ORDER BY name

    SET @rc = @@ROWCOUNT
END

DROP TABLE #db

--SELECT SUSER_SID('AD-BAYER-CNB\EUAYG') AS EUAYG -- SELECT [dbo].[fn_SIDToString](0x010500000000000515000000D5CB5C589331DA1C828BA628D71C0F00) AS EUAYG -- S-1-5-21-1482476501-484061587-682003330-990423
--SELECT SUSER_SID('AD-BAYER-CNB\EUBNY') AS EUBNY -- SELECT [dbo].[fn_SIDToString](0x010500000000000515000000D5CB5C589331DA1C828BA628C0310F00) AS EUBNY -- S-1-5-21-1482476501-484061587-682003330-995776
/*
S-1-5-21-343818398-1383384898-725345543    ;ap.agrogroup.net;AP-AGRO-NET
S-1-5-21-2474866813-2766037476-1139015981  ;ap.bayer.cnb;AP-BAYER-CNB
S-1-5-21-111243014-48569388-1101818912     ;na.bayer.cnb;BAYER1
S-1-5-21-3902661574-179482470-2665799705   ;emea.healthcare.cnb;BHC-EMEA
S-1-5-21-3022082863-4264158412-2505249813  ;ap.healthcare.cnb;BHC-AP
S-1-5-21-1630070417-3406918176-678495075   ;na.healthcare.cnb;BHC-NA
S-1-5-21-2050033333-681274564-2079600828   ;DE.BAYER.cnb;BYACCOUNT
S-1-5-21-2024126122-1151873134-1585518491  ;la.bayer.cnb;LA-BAYER-CNB
S-1-5-21-1757981266-329068152-682003330    ;emea.agrogroup.net;EMEA
S-1-5-21-2038715764-1839999106-1341851483  ;na.agrogroup.net;RTP
*/
